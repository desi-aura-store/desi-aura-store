<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shop - Desi Aura</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="icon" type="image/x-icon" href="/images/desi-aura.ico">
<link rel="shortcut icon" href="/images/desi-aura.ico">
  <script src="assets/js/config.js"></script>
  <script src="assets/js/api.js" defer></script>
  <script src="assets/js/cart.js"></script>
  <script src="assets/js/product-ui.js" defer></script>
  <script src="assets/js/router.js"></script>
</head>
  <body>
  <header>
    <h1>Desi Aura</h1>
    <nav>
      <a href="/index.html">Home</a>
      <a href="/shop.html">Shop</a>
      <a href="/cart.html">Cart <span id="cart-count" class="cart-count">0</span></a>
      <a href="/order-status.html">Track Order</a>
    </nav>
  </header>

  <section class="hero small-hero">
    <h2>Our Collection</h2>
    <p>Explore authentic fashion & accessories</p>
  </section>

  <main>
    <section class="products" id="shop-products">
      <!-- All products will load here via JS -->
    </section>
  </main>

 <footer>
  <p>&copy; 2025 Desi Aura. All rights reserved.</p>
  <div class="footer-links">
    <a href="/order-status.html">Track Order</a>
    <a href="/contact.html">Contact Us</a>
  </div>
</footer>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const shopContainer = document.getElementById("shop-products");
  let offset = 0;
  const limit = 12;
  let loading = false;
  let done = false;

  function showMessage(text) {
    shopContainer.innerHTML = `<div class="empty-message">${text}</div>`;
  }

  async function loadProducts() {
    if (loading || done) return;
    loading = true;

    // loader element
    const loaderId = 'shop-loader';
    if (!document.getElementById(loaderId)) {
      const loader = document.createElement('div');
      loader.id = loaderId;
      loader.className = 'loader';
      loader.innerText = 'Loading products...';
      shopContainer.appendChild(loader);
    }

    try {
      // Get category from URL if present
      const urlParams = new URLSearchParams(window.location.search);
      const category = urlParams.get('category');
      
      // FIX: Add /api to the URL
      let apiUrl = `${window.API_BASE_URL}/api/products?limit=${limit}&offset=${offset}`;
      if (category) {
        apiUrl += `&category=${category}`;
      }
      
      console.log('Fetching products from:', apiUrl);
      
      const res = await fetch(apiUrl, { 
        cache: 'no-store',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      if (!res.ok) throw new Error('API error ' + res.status);
      const products = await res.json();

      const loaderEl = document.getElementById(loaderId);
      if (loaderEl) loaderEl.remove();

      if (!Array.isArray(products) || products.length === 0) {
        if (offset === 0) showMessage('No products found.');
        done = true;
        loading = false;
        return;
      }

      // Update the product card creation in shop.html
      products.forEach(p => {
        const card = document.createElement('div');
        card.className = 'product-card fade-in';
        
        // Calculate discount percentage if original price exists
        const discountPercent = p.originalPrice ? 
          Math.round((1 - p.price / p.originalPrice) * 100) : 0;
        
        // Get the first image from comma-separated list
        const imageArray = p.image ? p.image.split(',') : [];
        const firstImageSrc = imageArray.length > 0 ? imageArray[0].trim() : 'placeholder.jpg';
        
        // Create product card HTML
        card.innerHTML = `
          <div class="image-wrap">
            <a class="product-link" href="/product.html?id=${p.id}" aria-label="${p.name}">
              <img 
                src="/images/${firstImageSrc}" 
                alt="${p.name}"
                onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjMyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIE5vdCBGb3VuZDwvdGV4dD48L3N2Zz4='"
              >
            </a>
            <div class="actions">
              <button class="add-btn" data-id="${p.id}" data-name="${encodeURIComponent(p.name)}" data-price="${p.price}">Add to cart</button>
              <button class="buy-btn" data-id="${p.id}" data-name="${encodeURIComponent(p.name)}" data-price="${p.price}">Buy now</button>
            </div>
          </div>
          <div class="product-info">
            <h3>${p.name}</h3>
            <div class="price-container">
              ${p.originalPrice ? `<span class="original-price">₹${p.originalPrice}</span>` : ''}
              <span class="current-price">₹${p.price}</span>
              ${discountPercent > 0 ? `<span class="discount-badge">${discountPercent}% OFF</span>` : ''}
            </div>
          </div>
        `;
        shopContainer.appendChild(card);
      });

      offset += products.length;
      if (products.length < limit) done = true;
    } catch (err) {
      console.error('Error loading products:', err);
      const loaderEl = document.getElementById(loaderId);
      if (loaderEl) loaderEl.remove();
      if (offset === 0) showMessage('Failed to load products. See console.');
      done = true;
    } finally {
      loading = false;
    }
  }

  // initial load
  loadProducts();

  // infinite scroll trigger
  window.addEventListener('scroll', () => {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 220) {
      loadProducts();
    }
  });

  // NOTE: Add/Buy click handling and touch reveal are handled by assets/js/product-ui.js
});
</script>
</body>
</html>
